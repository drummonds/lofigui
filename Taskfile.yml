# https://taskfile.dev

version: "3"

vars:
  PYTHON: python3

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list
    silent: true

  # Development tasks
  install:
    desc: Install development dependencies
    cmds:
      - uv sync --all-extras

  test:
    desc: Run tests
    cmds:
      - uv run pytest
      - go test ./...

  test-coverage:
    desc: Run tests with coverage report
    cmds:
      - uv run pytest --cov=lofigui --cov-report=html --cov-report=xml --cov-report=term-missing

  lint:
    desc: Run all linters
    cmds:
      - task: lint-black
      - task: lint-flake8
      # - task: lint-mypy

  lint-black:
    desc: Check code formatting with black
    cmds:
      - .venv/bin/black --check lofigui tests

  lint-flake8:
    desc: Run flake8 linter
    cmds:
      - .venv/bin/flake8 lofigui tests --max-line-length=100 --extend-ignore=E203,W503,F401

  lint-mypy:
    desc: Run mypy type checker
    cmds:
      - .venv/bin/mypy lofigui

  format:
    desc: Format code with black
    cmds:
      - .venv/bin/black lofigui tests

  check-licenses:
    desc: Check Go dependencies for license compliance
    cmds:
      - go install github.com/google/go-licenses@latest
      - go-licenses check ./... --allowed_licenses MIT,Apache-2.0,BSD-2-Clause,BSD-3-Clause,ISC,MPL-2.0

  build:
    desc: Build package distribution
    cmds:
      - uv build

  # Python example tasks
  example-01:
    desc: Run Python example 01 (Hello World with FastAPI)
    aliases: [py01]
    dir: examples/01_hello_world/python
    cmds:
      - uv sync --no-install-project
      - uv run --no-project python hello.py

  example-02:
    desc: Run Python example 02 (SVG Graph with Pygal)
    aliases: [py02]
    dir: examples/02_svg_graph/python
    cmds:
      - uv sync --no-install-project
      - uv run --no-project python graph.py

  example-05:
    desc: Run Python example 05 (Demo App with template inheritance)
    aliases: [py05, demo]
    dir: examples/05_demo_app
    cmds:
      - uv sync --no-install-project
      - uv run --no-project python demo_app.py

  example-06:
    desc: Run Python example 06 (Notes CRUD)
    aliases: [py06]
    dir: examples/06_notes_crud/python
    cmds:
      - uv sync --no-install-project
      - uv run --no-project python notes.py

  # Go example tasks (wildcard)
  go-example:*:
    desc: 'Run Go example (use go-wasm:NN for WASM examples)'
    vars:
      NUM: '{{index .MATCH 0}}'
      EXAMPLE_DIR:
        sh: ls -d examples/{{index .MATCH 0}}_*/go 2>/dev/null || echo ""
    preconditions:
      - sh: '[ -n "{{.EXAMPLE_DIR}}" ]'
        msg: 'No Go example found for number {{.NUM}}'
      - sh: '[ ! -f "build.sh" ]'
        msg: 'Example {{.NUM}} is a WASM example — use task go-wasm:{{.NUM}} instead'
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - go mod tidy
      - go run main.go

  go-wasm:*:
    desc: 'Build and serve Go WASM example'
    vars:
      NUM: '{{index .MATCH 0}}'
      EXAMPLE_DIR:
        sh: ls -d examples/{{index .MATCH 0}}_*/go 2>/dev/null || echo ""
    preconditions:
      - sh: '[ -n "{{.EXAMPLE_DIR}}" ]'
        msg: 'No Go example found for number {{.NUM}}'
      - sh: '[ -f "build.sh" ]'
        msg: 'Example {{.NUM}} is not a WASM example — use task go-example:{{.NUM}} instead'
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - chmod +x build.sh
      - ./build.sh
      - echo ""
      - echo "Build complete! Starting server..."
      - cd .. && {{.PYTHON}} serve.py

  build-wasm:*:
    desc: 'Build WASM binary only (no serve)'
    vars:
      NUM: '{{index .MATCH 0}}'
      EXAMPLE_DIR:
        sh: ls -d examples/{{index .MATCH 0}}_*/go 2>/dev/null || echo ""
    preconditions:
      - sh: '[ -n "{{.EXAMPLE_DIR}}" ]'
        msg: 'No Go example found for number {{.NUM}}'
      - sh: '[ -f "build.sh" ]'
        msg: 'Example {{.NUM}} is not a WASM example'
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - chmod +x build.sh
      - ./build.sh

  # Go module tidy tasks (wildcard)
  tidy:
    desc: Run go tidy and update for all
    deps: [tidy:main, tidy:01, tidy:02, tidy:03, tidy:04, tidy:06]

  tidy:main:
    desc: Run go tidy and update main
    cmds:
      - go mod tidy
      - go get -u ./...

  tidy:*:
    desc: 'Run go tidy and update for example'
    vars:
      NUM: '{{index .MATCH 0}}'
      EXAMPLE_DIR:
        sh: ls -d examples/{{index .MATCH 0}}_*/go 2>/dev/null || echo ""
    preconditions:
      - sh: '[ -n "{{.EXAMPLE_DIR}}" ]'
        msg: 'No Go example found for number {{.NUM}}'
    dir: '{{.EXAMPLE_DIR}}'
    cmds:
      - go mod tidy
      - go get -u ./...

  # Release task (pattern from github.com/drummonds/godocs)
  release:*:*:
    desc: 'Release process eg task release:v0.14.0:"new feature"'
    vars:
      TAG: '{{index .MATCH 0}}'
      BUILD: '{{index .MATCH 1}}'
    cmds:
      - task: test
      - task: lint
      - task: build
      - git add .
      - git commit -am "{{.BUILD}}"
      - git tag "{{.TAG}}"
      - git push origin "{{.TAG}}"
      - git push
